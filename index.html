<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ferrao Generator</title>
<style>
* {margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, sans-serif;}
body { background:#0f1e0f; color:#fff; display:flex; flex-direction:column; align-items:center; min-height:100vh;}
header { width:100%; background:#1b3a1b; padding:15px; display:flex; justify-content:space-between; align-items:center; position:relative;}
.menu { font-size:28px; cursor:pointer;}
.dropdown { display:none; flex-direction:column; background:#225522; width:100%; position:absolute; top:60px; left:0; z-index:999;}
.dropdown a { padding:10px; color:#fff; text-decoration:none;}
.card { background:#1f3a1f; padding:20px; border-radius:15px; margin:15px; width:90%; max-width:500px; text-align:center; transition: all 0.3s; }
.card:hover { transform: translateY(-5px); box-shadow: 0 0 20px #3fc03f;}
button{background:#3fc03f;color:#fff;border:none;padding:10px 20px;border-radius:10px;cursor:pointer;margin:5px;}
input{ width:90%; padding:10px; margin:6px 0; border-radius:8px; border:none; background:#225522; color:#fff;}
.avatar{width:60px;height:60px;border-radius:50%;object-fit:cover;border:2px solid #3fc03f; cursor:pointer;}
</style>
</head>
<body>

<header>
  <div>Ferrao Generator</div>
  <div>
    <span id="userHeader"></span>
    <button id="btnLogout" style="display:none;" onclick="logout()">Sair</button>
    <span class="menu" onclick="toggleMenu()">☰</span>
  </div>
</header>

<div id="dropdown" class="dropdown">
  <a href="#" onclick="showHome()">Home</a>
  <a href="#" onclick="showLogin()">Entrar</a>
  <a href="#" onclick="showRegister()">Cadastrar</a>
</div>

<div id="main"></div>

<script>
let currentUser = null;

// Suas APIs
const USERS_API = "https://gerador-online-9fqv.vercel.app/dados";
const KEYS_API = "https://teste-api-mcok.vercel.app/keys";

// Toggle menu
function toggleMenu(){
  const d = document.getElementById("dropdown");
  d.style.display = d.style.display==="flex"?"none":"flex";
}

// Home
function showHome(){
  document.getElementById("main").innerHTML = `
    <div class="card">
      <h2>Bem-vindo ao Ferrao Generator</h2>
      <p>Cadastre-se ou faça login para começar a gerar keys.</p>
      <button onclick="showRegister()">Cadastrar</button>
      <button onclick="showLogin()">Entrar</button>
    </div>`;
}

// Login
function showLogin(){
  document.getElementById("main").innerHTML = `
    <div class="card">
      <h2>Entrar</h2>
      <input type="text" id="loginUser" placeholder="Usuário">
      <input type="password" id="loginPass" placeholder="Senha">
      <button onclick="login()">Entrar</button>
      <p id="loginStatus" style="color:#ff5555;"></p>
    </div>`;
}

async function login(){
  const u = document.getElementById("loginUser").value.trim();
  const p = document.getElementById("loginPass").value.trim();
  const status = document.getElementById("loginStatus");

  if(!u || !p){ status.innerText="Preencha os campos"; return; }

  try{
    const res = await fetch(USERS_API);
    if(!res.ok) throw new Error("Erro HTTP: "+res.status);
    const users = await res.json();

    const user = users.find(x=>x.username===u && x.password===p);
    if(!user){ status.innerText="Usuário ou senha inválidos"; return; }

    currentUser = user;
    showDashboard();

  }catch(e){
    status.innerText = "Erro ao conectar API";
    console.error(e);
  }
}

// Register
function showRegister(){
  document.getElementById("main").innerHTML = `
    <div class="card">
      <h2>Cadastrar</h2>
      <div><img src="https://via.placeholder.com/60" class="avatar" id="regAvatar" onclick="uploadAvatar(this)"></div>
      <input type="text" id="regUser" placeholder="Usuário">
      <input type="password" id="regPass" placeholder="Senha">
      <button onclick="register()">Cadastrar</button>
      <p id="regStatus" style="color:#ff5555;"></p>
    </div>`;
}

function uploadAvatar(img){
  const file = document.createElement("input"); file.type="file"; file.accept="image/*";
  file.onchange = e => {
    const reader = new FileReader();
    reader.onload = ()=> img.src = reader.result;
    reader.readAsDataURL(e.target.files[0]);
  }
  file.click();
}

async function register(){
  const u = document.getElementById("regUser").value.trim();
  const p = document.getElementById("regPass").value.trim();
  const avatar = document.getElementById("regAvatar").src;
  const status = document.getElementById("regStatus");

  if(!u || !p){ status.innerText="Preencha os campos!"; return; }

  try{
    const res = await fetch(USERS_API);
    if(!res.ok) throw new Error("Erro HTTP: "+res.status);
    const users = await res.json();
    if(users.find(x=>x.username===u)){ status.innerText="Usuário já existe!"; return; }

    alert("Cadastro feito! (sua API precisa aceitar POST para salvar de verdade)");
    showLogin();

  }catch(e){ status.innerText="Erro ao conectar API"; console.error(e); }
}

// Dashboard
function showDashboard(){
  document.getElementById("btnLogout").style.display="inline-block";
  document.getElementById("userHeader").textContent = `${currentUser.username} (${currentUser.plan||'Sem plano'})`;

  if(currentUser.admin){
    document.getElementById("main").innerHTML = `
      <div class="card"><h2>Painel Admin</h2>
        <button onclick="adminLoadUsers()">Carregar Usuários</button>
      </div>
      <div id="usersList"></div>`;
  }else{
    document.getElementById("main").innerHTML = `
      <div class="card">
        <h2>Dashboard</h2>
        <img src="${currentUser.avatar}" class="avatar">
        <p>Plano: ${currentUser.plan||'Sem plano'}</p>
        <p>Keys geradas: ${currentUser.keysGenerated||0}/${currentUser.planLimit||0}</p>
        <button onclick="showGenerateKey()">Gerar key</button>
      </div>
      <div id="userKeys"></div>`;
  }
}

// Admin - Listar usuários
async function adminLoadUsers(){
  try{
    const res = await fetch(USERS_API);
    if(!res.ok) throw new Error("Erro HTTP: "+res.status);
    const users = await res.json();
    const div = document.getElementById("usersList");
    div.innerHTML = "";
    users.forEach(u=>{
      div.innerHTML += `
      <div class="card">
        <img src="${u.avatar}" class="avatar">
        <p>${u.username} — ${u.plan||'Nenhum'}</p>
        <p>Keys: ${u.keysGenerated||0}/${u.planLimit||0}</p>
        <button onclick="promptAssignPlan('${u.username}')">Atribuir Plano</button>
      </div>`;
    });
  }catch(e){ alert("Erro ao carregar usuários"); console.error(e);}
}

// Planos
async function promptAssignPlan(username){
  const plan = prompt("Nome do plano:");
  const limit = parseInt(prompt("Limite de keys:"));
  const days = parseInt(prompt("Duração em dias:"));
  const planEnd = new Date(Date.now()+days*86400000).toISOString();

  alert("Função de salvar plano precisa que a API aceite POST ou PUT para atualizar usuários");

  adminLoadUsers();
}

// Gerar key
function showGenerateKey(){
  if(!currentUser.plan){ alert("Adquira um plano para gerar keys!"); return; }
  const tipo = prompt("Tipo de key (hour/day/month/year):");
  if(!tipo) return;

  const randomStr = Math.random().toString(36).substring(2,10).toUpperCase();
  const newKey = `FERRAO-CHEATS-${randomStr}`;

  fetch(KEYS_API, { method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify({ key:newKey, type:tipo, username:currentUser.username, deviceUsed:false }) })
    .then(()=>alert("Key gerada!"))
    .catch(()=>alert("Erro ao gerar key"));
}

// Logout
function logout(){
  currentUser=null;
  document.getElementById("btnLogout").style.display="none";
  document.getElementById("userHeader").textContent="";
  showHome();
}

// Inicializa
showHome();
</script>

</body>
</html>
