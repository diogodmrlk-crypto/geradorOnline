<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ferrao Panel</title>

<style>
body{
background:#0f1e0f;
color:white;
font-family:Segoe UI;
display:flex;
flex-direction:column;
align-items:center;
}

.card{
background:#1f3a1f;
padding:20px;
border-radius:20px;
margin:15px;
width:95%;
max-width:800px;
}

button{
background:#3fc03f;
border:none;
padding:10px 20px;
border-radius:10px;
color:white;
margin:5px;
cursor:pointer;
}

select{
padding:10px;
border-radius:10px;
border:none;
background:#225522;
color:white;
}

table{
width:100%;
margin-top:15px;
border-collapse:collapse;
}

td,th{
padding:10px;
border-bottom:1px solid #2c5c2c;
}
.tab{
cursor:pointer;
padding:10px;
display:inline-block;
background:#225522;
margin:5px;
border-radius:10px;
}
</style>
</head>

<body>

<div id="app"></div>

<script>

const USERS_API="https://gerador-online-9fqv.vercel.app/dados";
const KEYS_API="https://teste-api-mcok.vercel.app/keys";

let currentUser=null;
let selectedUser=null;

// LOGIN
function home(){
app.innerHTML=`
<div class="card">
<h2>Login</h2>
<input id="user" placeholder="Usuário">
<input id="pass" type="password" placeholder="Senha">
<button onclick="login()">Entrar</button>
</div>`;
}

async function login(){

const users=await fetch(USERS_API).then(r=>r.json());

const u=user.value;
const p=pass.value;

const found=users.find(x=>x.username===u && x.password===p);

if(!found) return alert("Login inválido");

currentUser=found;

if(found.admin){
adminPanel();
}else{
userPanel();
}
}

// USER DASHBOARD
function userPanel(){

if(!currentUser.plan){
app.innerHTML=`<div class="card"><h2>Sem plano</h2></div>`;
return;
}

app.innerHTML=`

<div class="card">
<h2>Gerar Key</h2>

<select id="tipo">
<option value="hour">1 Hora</option>
<option value="day">1 Dia</option>
<option value="month">1 Mês</option>
</select>

<button onclick="generateKey()">Gerar</button>
</div>

<div class="card">
<h3>Minhas Keys</h3>
<table>
<thead>
<tr>
<th>Key</th>
<th>Status</th>
<th>Device</th>
<th>Timer</th>
<th>Ações</th>
</tr>
</thead>
<tbody id="keysTable"></tbody>
</table>
</div>
`;

loadKeys(currentUser.username);
setInterval(()=>loadKeys(currentUser.username),3000);
}

// ADMIN
async function adminPanel(){

const users=await fetch(USERS_API).then(r=>r.json());

app.innerHTML=`
<div class="card">
<h2>Admin - Usuários</h2>
<div id="tabs"></div>
<div id="adminKeys"></div>
</div>
`;

users.forEach(u=>{
tabs.innerHTML+=`<div class="tab" onclick="openUser('${u.username}')">${u.username}</div>`;
});
}

function openUser(username){
selectedUser=username;

adminKeys.innerHTML=`
<h3>Keys de ${username}</h3>
<table>
<thead>
<tr>
<th>Key</th>
<th>Status</th>
<th>Device</th>
<th>Timer</th>
<th>Ações</th>
</tr>
</thead>
<tbody id="keysTable"></tbody>
</table>
`;

loadKeys(username);
}

// GERAR KEY
async function generateKey(){

const tipo=document.getElementById("tipo").value;

const key="FERRAO-CHEATS-"+Math.random().toString(36).substring(2,10).toUpperCase();

await fetch(KEYS_API,{
method:"POST",
headers:{'Content-Type':'application/json'},
body:JSON.stringify({
key,
type:tipo,
username:currentUser.username,
used:false,
revoked:false,
device:null,
createdAt:new Date().toISOString()
})
});

loadKeys(currentUser.username);
}

// LOAD KEYS
async function loadKeys(username){

const keys=await fetch(KEYS_API).then(r=>r.json());

const userKeys=keys.filter(k=>k.username===username);

keysTable.innerHTML="";

userKeys.forEach(k=>{

keysTable.innerHTML+=`
<tr>
<td>${k.key}</td>
<td>${k.revoked?"Revogada":"Ativa"}</td>
<td>${k.device||"Nenhum"}</td>
<td>${timer(k.createdAt,k.type)}</td>
<td>
<button onclick="revoke('${k.key}')">Revogar</button>
<button onclick="reset('${k.key}')">Reset</button>
<button onclick="del('${k.key}')">Excluir</button>
</td>
</tr>`;
});
}

// TIMER
function timer(created,type){

let ms=0;

if(type==="hour") ms=3600000;
if(type==="day") ms=86400000;
if(type==="month") ms=2592000000;

let end=new Date(created).getTime()+ms;
let diff=end-Date.now();

if(diff<=0) return "Expirado";

let m=Math.floor(diff/60000);
let s=Math.floor((diff%60000)/1000);

return m+"m "+s+"s";
}

// ACTIONS
async function revoke(key){
await fetch(KEYS_API+"/"+key,{
method:"PUT",
headers:{'Content-Type':'application/json'},
body:JSON.stringify({revoked:true})
});
}

async function reset(key){
await fetch(KEYS_API+"/"+key,{
method:"PUT",
headers:{'Content-Type':'application/json'},
body:JSON.stringify({device:null})
});
}

async function del(key){
await fetch(KEYS_API+"/"+key,{method:"DELETE"});
}

home();

</script>
</body>
</html>
