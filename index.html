<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ferrao Generator</title>

<style>
body{
background:#061a0b;
color:white;
font-family:Arial;
margin:0;
}

/* HEADER */
header{
background:#0c3b17;
padding:15px;
display:flex;
justify-content:space-between;
align-items:center;
}

/* BOTÕES */
.btn{
background:#2ecc71;
border:none;
padding:10px 20px;
border-radius:12px;
color:white;
font-weight:bold;
cursor:pointer;
margin:3px;
}

/* DASHBOARD */
.dashboard{
margin:20px;
background:#0d2f17;
padding:30px;
border-radius:25px;
text-align:center;
box-shadow:0 0 25px #2ecc71;
}

/* LISTA DE KEYS */
.keyTable{
margin:20px;
background:#0b2413;
border-radius:20px;
padding:15px;
}

.keyCard{
background:#081a0d;
padding:15px;
border-radius:15px;
margin-bottom:15px;
animation:fade 0.5s ease;
}

.status{
background:purple;
padding:4px 12px;
border-radius:12px;
font-size:13px;
}

@keyframes fade{
from{opacity:0; transform:translateY(10px);}
to{opacity:1; transform:translateY(0);}
}
</style>
</head>

<body>

<header>
<div>Ferrao Generator</div>
<div id="userInfo"></div>
<button class="btn" onclick="logout()">Sair</button>
</header>

<div class="dashboard">
<h2>Dashboard</h2>
<div id="planInfo"></div>
<br>
<button class="btn" onclick="gerarKey()">Gerar Key</button>
</div>

<div class="keyTable">
<h3>Minhas Keys</h3>
<div id="keysContainer"></div>
</div>

<script>

const USER_API="https://gerador-online-9fqv.vercel.app/dados";
const KEY_API="https://teste-api-mcok.vercel.app/keys";

/* ===== LOGIN CHECK SEM LOOP ===== */

let user = localStorage.getItem("user");

if(!user){
document.body.innerHTML="<h2 style='text-align:center;margin-top:50px'>Faça login primeiro</h2>";
throw new Error("Sem login");
}

user = JSON.parse(user);

document.getElementById("userInfo").innerText =
user.username+" ("+(user.plan||"sem plano")+")";

/* ===== TEMPO RESTANTE ===== */

function tempoRestante(data){
if(!data) return "Sem plano";

let diff = new Date(data) - new Date();
if(diff<=0) return "Expirado";

let d=Math.floor(diff/86400000);
let h=Math.floor(diff%86400000/3600000);
let m=Math.floor(diff%3600000/60000);
let s=Math.floor(diff%60000/1000);

return `${d}d ${h}h ${m}m ${s}s`;
}

/* ===== DASHBOARD ===== */

function atualizarDashboard(){

document.getElementById("planInfo").innerHTML=
`
Plano: ${user.plan || "Nenhum"}<br>
Expira em: ${tempoRestante(user.planEnd)}<br>
Keys geradas: ${user.keysGenerated || 0}/${user.planLimit || 0}
`;
}

/* ===== GERAR PREFIXO ===== */

function gerarCodigo(){
let chars="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
let code="";
for(let i=0;i<8;i++){
code+=chars[Math.floor(Math.random()*chars.length)];
}
return "FERRAO-CHEATS-"+code;
}

/* ===== GERAR KEY ===== */

async function gerarKey(){

if(!user.plan){
alert("Você não possui plano");
return;
}

if(user.keysGenerated >= user.planLimit){
alert("Limite atingido");
return;
}

let keyData={
key: gerarCodigo(),
type:"hour",
used:false,
revoked:false,
device:null,
createdAt:new Date().toISOString(),
owner:user.username
};

await fetch(KEY_API,{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify(keyData)
});

/* atualiza contador */

user.keysGenerated++;

await fetch(USER_API+"/"+user.username,{
method:"PUT",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({keysGenerated:user.keysGenerated})
});

localStorage.setItem("user",JSON.stringify(user));

carregarKeys();
atualizarDashboard();
}

/* ===== CARREGAR KEYS ===== */

async function carregarKeys(){

try{

let res = await fetch(KEY_API);
let keys = await res.json();

/* filtra apenas do usuário */
let minhas = keys.filter(k=>k.owner===user.username);

let container=document.getElementById("keysContainer");
container.innerHTML="";

/* render */
minhas.reverse().forEach(k=>{

container.innerHTML+=`
<div class="keyCard">

<b>${k.key}</b><br>

Status:
<span class="status">
${k.revoked ? "REVOGADA":"ATIVA"}
</span><br>

Criada:
${new Date(k.createdAt).toLocaleString()}<br>

Device:
${k.device || "Nenhum"}<br><br>

<button class="btn" onclick="revogar('${k.key}')">Revogar</button>
<button class="btn" onclick="resetar('${k.key}')">Resetar</button>
<button class="btn" onclick="excluir('${k.key}')">Excluir</button>

</div>
`;

});

}catch(e){
console.log("Erro ao carregar keys");
}
}

/* ===== AÇÕES ===== */

async function revogar(key){
await fetch(KEY_API+"/"+key,{
method:"PUT",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({revoked:true})
});
carregarKeys();
}

async function resetar(key){
await fetch(KEY_API+"/"+key,{
method:"PUT",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({device:null})
});
carregarKeys();
}

async function excluir(key){
await fetch(KEY_API+"/"+key,{method:"DELETE"});
carregarKeys();
}

/* ===== LOGOUT ===== */

function logout(){
localStorage.removeItem("user");
location.reload();
}

/* ===== AUTO REFRESH ===== */

setInterval(()=>{
carregarKeys();
atualizarDashboard();
},5000);

carregarKeys();
atualizarDashboard();

</script>

</body>
</html>
