<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ferrao Generator</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,sans-serif;}

body{
background:#0f1e0f;
color:#fff;
display:flex;
flex-direction:column;
align-items:center;
min-height:100vh;
}

header{
width:100%;
background:#1b3a1b;
padding:15px;
display:flex;
justify-content:space-between;
align-items:center;
}

.menu{font-size:28px;cursor:pointer;}

.dropdown{
display:none;
flex-direction:column;
background:#225522;
width:100%;
position:absolute;
top:60px;
left:0;
z-index:999;
}

.dropdown a{
padding:10px;
color:#fff;
text-decoration:none;
}

.card{
background:#1f3a1f;
padding:25px;
border-radius:20px;
margin:20px;
width:95%;
max-width:650px;
text-align:center;
transition:0.3s;
}

button{
background:#3fc03f;
color:#fff;
border:none;
padding:12px 25px;
border-radius:12px;
cursor:pointer;
margin:5px;
font-weight:bold;
}

button.danger{
background:#c03f3f;
}

button.warning{
background:#c0a03f;
}

input,select{
width:90%;
padding:12px;
margin:10px 0;
border-radius:10px;
border:none;
background:#225522;
color:#fff;
font-size:16px;
}

.keyItem{
background:#225522;
padding:10px;
border-radius:10px;
margin-top:8px;
text-align:left;
}

.userTab{
background:#225522;
padding:15px;
border-radius:10px;
margin:10px 0;
cursor:pointer;
transition:0.3s;
}

.userTab:hover{
background:#2a6b2a;
}

.userDetails{
display:none;
background:#1a4a1a;
padding:15px;
border-radius:10px;
margin-top:10px;
}

.timer{
color:#3fc03f;
font-weight:bold;
}

.expired{
color:#c03f3f;
}

.limit-warning{
background:#c0a03f;
color:#000;
padding:10px;
border-radius:10px;
margin:10px 0;
font-weight:bold;
}

.limit-error{
background:#c03f3f;
color:#fff;
padding:10px;
border-radius:10px;
margin:10px 0;
font-weight:bold;
}
</style>
</head>

<body>

<header>
<div>Ferrao Generator</div>
<div>
<span id="userHeader"></span>
<button id="btnLogout" onclick="logout()" style="display:none;">Sair</button>
<span class="menu" onclick="toggleMenu()">‚ò∞</span>
</div>
</header>

<div id="dropdown" class="dropdown">
<a onclick="showHome()">Home</a>
<a onclick="showLogin()">Entrar</a>
<a onclick="showRegister()">Cadastrar</a>
</div>

<div id="main"></div>

<script>

let currentUser=null;
let timers={};

const USERS_API="https://gerador-online-9fqv.vercel.app/dados";
const KEYS_API="https://teste-api-mcok.vercel.app/keys";

function toggleMenu(){
dropdown.style.display=dropdown.style.display==="flex"?"none":"flex";
}

function showHome(){
main.innerHTML=`
<div class="card">
<h2>Bem vindo</h2>
<p>Sistema de gera√ß√£o de keys</p>
</div>`;
}

function showLogin(){
main.innerHTML=`
<div class="card">
<h2>Login</h2>
<input id="loginUser" placeholder="Usu√°rio">
<input id="loginPass" type="password" placeholder="Senha">
<button onclick="login()">Entrar</button>
</div>`;
}

async function login(){
const u=loginUser.value;
const p=loginPass.value;

const res=await fetch(USERS_API);
const users=await res.json();

const user=users.find(x=>x.username===u && x.password===p);

if(!user) return alert("Login inv√°lido");

currentUser=user;

btnLogout.style.display="inline-block";
userHeader.innerText=user.username;

showDashboard();
}

function showRegister(){
main.innerHTML=`
<div class="card">
<h2>Cadastrar</h2>
<input id="regUser" placeholder="Usu√°rio">
<input id="regPass" placeholder="Senha">
<button onclick="register()">Cadastrar</button>
</div>`;
}

async function register(){
await fetch(USERS_API,{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
username:regUser.value,
password:regPass.value,
plan:"basico",
admin:false,
keysGenerated:0
})
});
alert("Criado");
showLogin();
}

async function showDashboard(){

// ADMIN
if(currentUser.admin){
await showAdminPanel();
return;
}

// USER BASICO GERADOR
const keysRes=await fetch(KEYS_API);
const allKeys=await keysRes.json();
const userKeysCount=allKeys.filter(k=>k.username===currentUser.username).length;

const limit=currentUser.plan==="avancado"?999999:500;
const remaining=limit-userKeysCount;

let limitHtml="";
if(remaining<=0){
limitHtml=`<div class="limit-error">‚ùå LIMITE ATINGIDO (${userKeysCount}/${limit})</div>`;
}else if(remaining<=50){
limitHtml=`<div class="limit-warning">‚ö†Ô∏è Voc√™ tem ${remaining} keys restantes de ${limit}</div>`;
}else{
limitHtml=`<div style="color:#3fc03f;margin:10px 0;">‚úÖ Keys: ${userKeysCount}/${limit}</div>`;
}

main.innerHTML=`

<div class="card">

<h2>Gerador de Keys</h2>

${limitHtml}

<label>Prefixo</label>
<input id="prefix" value="FERRAO-CHEATS-">

<label>Quantidade</label>
<input id="qty" type="number" value="1" max="${remaining}">

<label>Tipo</label>
<select id="type">
<option value="hour-1">1 Hora</option>
<option value="hour-3">3 Horas</option>
<option value="hour-6">6 Horas</option>
<option value="hour-12">12 Horas</option>
<option value="daily">1 Dia</option>
<option value="weekly">1 Semana</option>
<option value="perm">Vital√≠cia</option>
</select>

<button onclick="generate()" ${remaining<=0?"disabled":""}>Gerar</button>

<pre id="genOut">---</pre>

</div>

<div class="card">
<h2>Minhas Keys</h2>
<div id="userKeys"></div>
</div>

`;

loadUserKeys();
}

async function showAdminPanel(){

const usersRes=await fetch(USERS_API);
const users=await usersRes.json();

const keysRes=await fetch(KEYS_API);
const allKeys=await keysRes.json();

main.innerHTML=`
<div class="card">
<h2>üîß Painel Admin</h2>
<p>Gerenciar todos os usu√°rios e keys</p>
<div id="adminUsers"></div>
</div>`;

const adminUsers=document.getElementById("adminUsers");

users.forEach(user=>{

const userKeys=allKeys.filter(k=>k.username===user.username);

adminUsers.innerHTML+=`
<div class="userTab" onclick="toggleUserDetails('${user.username}')">
<b>üë§ ${user.username}</b> 
<span style="float:right;">
Plano: ${user.plan||"basico"} | Keys: ${userKeys.length}
</span>
</div>

<div id="details-${user.username}" class="userDetails">
<h3>Gerenciar ${user.username}</h3>

<label>Plano:</label>
<select id="plan-${user.username}">
<option value="basico" ${user.plan==="basico"?"selected":""}>B√°sico (500 keys)</option>
<option value="avancado" ${user.plan==="avancado"?"selected":""}>Avan√ßado (ilimitado)</option>
</select>

<button onclick="updateUserPlan('${user.username}')">Atualizar Plano</button>
<button class="danger" onclick="revokeUserPlan('${user.username}')">Revogar Plano</button>
<button class="warning" onclick="deleteUser('${user.username}')">Excluir Usu√°rio</button>

<h4 style="margin-top:20px;">Keys de ${user.username} (${userKeys.length})</h4>
<div id="keys-${user.username}"></div>

</div>
`;

// Renderizar keys do usu√°rio
setTimeout(()=>{
const keysDiv=document.getElementById(`keys-${user.username}`);
if(keysDiv){
userKeys.forEach(k=>{
keysDiv.innerHTML+=renderKeyItem(k,true);
});
startTimers();
}
},100);

});
}

function toggleUserDetails(username){
const details=document.getElementById(`details-${username}`);
details.style.display=details.style.display==="block"?"none":"block";
}

async function updateUserPlan(username){
const newPlan=document.getElementById(`plan-${username}`).value;

const usersRes=await fetch(USERS_API);
const users=await usersRes.json();
const user=users.find(u=>u.username===username);

if(!user) return alert("Usu√°rio n√£o encontrado");

await fetch(USERS_API+"/"+user.id,{
method:"PUT",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({...user,plan:newPlan})
});

alert(`Plano de ${username} atualizado para ${newPlan}`);
showAdminPanel();
}

async function revokeUserPlan(username){
if(!confirm(`Revogar plano de ${username}?`)) return;

const usersRes=await fetch(USERS_API);
const users=await usersRes.json();
const user=users.find(u=>u.username===username);

if(!user) return alert("Usu√°rio n√£o encontrado");

await fetch(USERS_API+"/"+user.id,{
method:"PUT",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({...user,plan:null})
});

alert(`Plano de ${username} revogado`);
showAdminPanel();
}

async function deleteUser(username){
if(!confirm(`EXCLUIR usu√°rio ${username}? Isso √© irrevers√≠vel!`)) return;

const usersRes=await fetch(USERS_API);
const users=await usersRes.json();
const user=users.find(u=>u.username===username);

if(!user) return alert("Usu√°rio n√£o encontrado");

await fetch(USERS_API+"/"+user.id,{method:"DELETE"});

// Excluir todas as keys do usu√°rio
const keysRes=await fetch(KEYS_API);
const allKeys=await keysRes.json();
const userKeys=allKeys.filter(k=>k.username===username);

for(let key of userKeys){
await fetch(KEYS_API+"/"+key.key,{method:"DELETE"});
}

alert(`Usu√°rio ${username} exclu√≠do`);
showAdminPanel();
}

function rand(len){
const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
let s="";
for(let i=0;i<len;i++){
s+=chars[Math.floor(Math.random()*chars.length)];
}
return s;
}

async function generate(){

if(!currentUser.plan) return alert("Voc√™ n√£o possui plano");

const keysRes=await fetch(KEYS_API);
const allKeys=await keysRes.json();
const userKeysCount=allKeys.filter(k=>k.username===currentUser.username).length;

const limit=currentUser.plan==="avancado"?999999:500;

if(userKeysCount>=limit){
return alert("LIMITE ATINGIDO! Voc√™ n√£o pode gerar mais keys.");
}

const qtyRequested=parseInt(qty.value);
const remaining=limit-userKeysCount;

if(qtyRequested>remaining){
return alert(`Voc√™ s√≥ pode gerar mais ${remaining} keys!`);
}

genOut.textContent="Gerando...\n";

for(let i=0;i<qtyRequested;i++){

const key=prefix.value+rand(8);

await fetch(KEYS_API,{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
key:key,
type:type.value,
username:currentUser.username,
used:false,
device:null,
createdAt:Date.now()
})
});

genOut.textContent+=key+"\n";
}

await showDashboard();
}

function renderKeyItem(k,isAdmin=false){

let timeDisplay="";
let isExpired=false;

if(k.type!=="perm"){
const result=calculateTimeRemaining(k);
timeDisplay=result.display;
isExpired=result.expired;
}else{
timeDisplay="<span style='color:#ffd700;'>‚ôæÔ∏è VITAL√çCIA</span>";
}

return `
<div class="keyItem">
<b>${k.key}</b><br>
Tipo: ${k.type}<br>
Device: ${k.device||"‚Äî"}<br>
Status: ${isExpired?"<span class='expired'>EXPIRADA</span>":timeDisplay}
<div id="timer-${k.key}"></div>

<button onclick="revokeKey('${k.key}',${isAdmin})">Revogar</button>
<button onclick="resetDevice('${k.key}',${isAdmin})">Resetar Device</button>
<button class="danger" onclick="deleteKey('${k.key}',${isAdmin})">Excluir</button>

</div>`;
}

async function loadUserKeys(){

const res=await fetch(KEYS_API);
const data=await res.json();

userKeys.innerHTML="";

data
.filter(k=>k.username===currentUser.username)
.forEach(k=>{
userKeys.innerHTML+=renderKeyItem(k,false);
});

startTimers();
}

function calculateTimeRemaining(key){

if(!key.createdAt){
return {display:"‚è≥ Aguardando ativa√ß√£o",expired:false};
}

const created=key.createdAt;
const now=Date.now();
const elapsed=now-created;

let duration=0;

if(key.type.startsWith("hour-")){
const hours=parseInt(key.type.split("-")[1]);
duration=hours*60*60*1000;
}else if(key.type==="daily"){
duration=24*60*60*1000;
}else if(key.type==="weekly"){
duration=7*24*60*60*1000;
}else if(key.type==="perm"){
return {display:"‚ôæÔ∏è VITAL√çCIA",expired:false};
}

const remaining=duration-elapsed;

if(remaining<=0){
return {display:"<span class='expired'>‚è∞ EXPIRADA</span>",expired:true};
}

const hours=Math.floor(remaining/(60*60*1000));
const minutes=Math.floor((remaining%(60*60*1000))/(60*1000));
const seconds=Math.floor((remaining%(60*1000))/1000);

return {
display:`<span class='timer'>‚è±Ô∏è ${hours}h ${minutes}m ${seconds}s</span>`,
expired:false,
remaining:remaining
};
}

function startTimers(){

// Limpar timers antigos
for(let key in timers){
clearInterval(timers[key]);
}
timers={};

// Buscar todas as keys
fetch(KEYS_API).then(res=>res.json()).then(allKeys=>{

allKeys.forEach(key=>{

const timerEl=document.getElementById(`timer-${key.key}`);

if(!timerEl || key.type==="perm") return;

timers[key.key]=setInterval(()=>{

const result=calculateTimeRemaining(key);

if(timerEl){
timerEl.innerHTML=result.display;
}

if(result.expired){
clearInterval(timers[key.key]);
}

},1000);

});
});
}

async function revokeKey(key,isAdmin){

await fetch(KEYS_API+"/"+key,{
method:"PUT",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({used:true})
});

if(isAdmin){
showAdminPanel();
}else{
loadUserKeys();
}
}

async function resetDevice(key,isAdmin){

await fetch(KEYS_API+"/"+key,{
method:"PUT",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({device:null})
});

if(isAdmin){
showAdminPanel();
}else{
loadUserKeys();
}
}

async function deleteKey(key,isAdmin){

if(!confirm("Excluir esta key permanentemente?")) return;

await fetch(KEYS_API+"/"+key,{method:"DELETE"});

if(isAdmin){
showAdminPanel();
}else{
loadUserKeys();
}
}

function logout(){
currentUser=null;
btnLogout.style.display="none";
userHeader.innerText="";

// Limpar timers
for(let key in timers){
clearInterval(timers[key]);
}
timers={};

showHome();
}

showHome();

</script>
</body>
</html>
