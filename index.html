<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ferrao Generator</title>

<style>
body{
background:#061a0b;
color:white;
font-family:Arial;
margin:0;
}

header{
background:#0c3b17;
padding:15px;
display:flex;
justify-content:space-between;
align-items:center;
}

.btn{
background:#2ecc71;
border:none;
padding:12px 25px;
border-radius:12px;
color:white;
font-weight:bold;
cursor:pointer;
}

.dashboard{
margin:20px;
background:#0d2f17;
padding:30px;
border-radius:25px;
text-align:center;
box-shadow:0 0 25px #2ecc71;
}

.keyTable{
margin:20px;
background:#0b2413;
border-radius:20px;
padding:15px;
}

.keyCard{
background:#081a0d;
padding:15px;
border-radius:15px;
margin-bottom:15px;
animation:fade 0.5s ease;
}

.status{
background:purple;
padding:5px 15px;
border-radius:15px;
}

@keyframes fade{
from{opacity:0; transform:translateY(15px);}
to{opacity:1; transform:translateY(0);}
}
</style>
</head>

<body>

<header>
<div>Ferrao Generator</div>
<div id="userInfo"></div>
<button class="btn" onclick="logout()">Sair</button>
</header>

<div class="dashboard">
<h2>Dashboard</h2>

<div id="planInfo"></div>
<br>
<button class="btn" onclick="gerarKey()">Gerar Key</button>
</div>

<div class="keyTable">
<h3>Minhas Keys</h3>
<div id="keysContainer"></div>
</div>

<script>

const USER_API="https://gerador-online-9fqv.vercel.app/dados";
const KEY_API="https://teste-api-mcok.vercel.app/keys";

let user = JSON.parse(localStorage.getItem("user"));

if(!user){
alert("Fa√ßa login primeiro");
location.reload();
}

document.getElementById("userInfo").innerText =
user.username+" ("+(user.plan||"sem plano")+")";

function tempoRestante(data){
if(!data) return "Sem plano";
let diff = new Date(data) - new Date();
if(diff <=0) return "Expirado";

let d=Math.floor(diff/86400000);
let h=Math.floor(diff%86400000/3600000);
let m=Math.floor(diff%3600000/60000);
let s=Math.floor(diff%60000/1000);

return `${d}d ${h}h ${m}m ${s}s`;
}

async function atualizarDashboard(){

document.getElementById("planInfo").innerHTML=
`
Plano: ${user.plan || "Nenhum"}<br>
Expira em: ${tempoRestante(user.planEnd)}<br>
Keys geradas: ${user.keysGenerated || 0}/${user.planLimit || 0}
`;

}

function gerarCodigo(){
let chars="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
let code="";
for(let i=0;i<8;i++){
code+=chars[Math.floor(Math.random()*chars.length)];
}
return "FERRAO-CHEATS-"+code;
}

async function gerarKey(){

if(!user.plan){
alert("Adquira um plano");
return;
}

if(user.keysGenerated >= user.planLimit){
alert("Limite atingido");
return;
}

let keyData={
key: gerarCodigo(),
type:"hour",
used:false,
revoked:false,
device:null,
createdAt:new Date().toISOString(),
owner:user.username
};

await fetch(KEY_API,{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify(keyData)
});

user.keysGenerated++;
await fetch(USER_API+"/"+user.username,{
method:"PUT",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({keysGenerated:user.keysGenerated})
});

localStorage.setItem("user",JSON.stringify(user));

carregarKeys();
atualizarDashboard();
}

async function carregarKeys(){

let res=await fetch(KEY_API);
let keys=await res.json();

let minhas = keys.filter(k=>k.owner===user.username);

let container=document.getElementById("keysContainer");
container.innerHTML="";

minhas.reverse().forEach(k=>{

container.innerHTML+=`
<div class="keyCard">
<b>${k.key}</b><br>
Status: <span class="status">${k.revoked ? "REVOGADA":"ATIVA"}</span><br>
Criada: ${new Date(k.createdAt).toLocaleString()}<br>
Device: ${k.device || "Nenhum"}<br><br>

<button class="btn" onclick="revogar('${k.key}')">Revogar</button>
<button class="btn" onclick="resetar('${k.key}')">Resetar</button>
<button class="btn" onclick="excluir('${k.key}')">Excluir</button>
</div>
`;

});

}

async function revogar(key){
await fetch(KEY_API+"/"+key,{
method:"PUT",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({revoked:true})
});
carregarKeys();
}

async function resetar(key){
await fetch(KEY_API+"/"+key,{
method:"PUT",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({device:null})
});
carregarKeys();
}

async function excluir(key){
await fetch(KEY_API+"/"+key,{method:"DELETE"});
carregarKeys();
}

function logout(){
localStorage.removeItem("user");
location.reload();
}

setInterval(()=>{
carregarKeys();
atualizarDashboard();
},5000);

carregarKeys();
atualizarDashboard();

</script>

</body>
</html>
